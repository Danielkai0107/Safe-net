# 接收點管理功能說明

## 功能概述

新增了完整的接收點（Gateway）管理系統，包含接收點管理、長輩行蹤記錄、邊界點警報等功能。

## 核心功能

### 1. 接收點管理 (`/admin/gateways`)

**欄位說明：**
- **接收點編號**：自動產生，格式為「社區名稱前3字 + 001、002...」
  - 例如：「大安社001」、「大安社002」
- **所屬社區**：該接收點屬於哪個社區
- **接收裝置序號**：接收點的硬體序號（例如：SIM-001）
- **地點名稱**：接收點的位置（例如：社區大門、後門、活動中心）
- **詳細地址**：接收點的完整地址（選填）
- **是否為邊界點**：
  - ✅ 邊界點：長輩經過時會立即發送 LINE 通知
  - ❌ 一般接收點：僅記錄行蹤，不發送通知
- **狀態**：
  - 運作中、停用、維護中

**操作功能：**
- ✅ 新增接收點
- ✅ 編輯接收點資訊
- ✅ 刪除接收點（更新為停用狀態）
- ✅ 按社區篩選接收點

### 2. 長輩行蹤記錄（自動記錄）

當長輩經過接收點時，系統會自動記錄：
- 長輩資訊（姓名、MAC Address）
- 接收點資訊（位置、編號）
- 訊號強度（RSSI）
- 時間戳記
- 是否為邊界點

**資料用途：**
- 追蹤長輩活動路徑
- 分析長輩作息規律
- 了解長輩常去的地點
- 邊界點警報觸發依據

### 3. 邊界點警報

**觸發條件：**
當長輩經過「邊界點」時，系統會：
1. 記錄到 locationLogs collection
2. 創建警報到 alerts collection
3. 發送 LINE 通知給社區管理員

**LINE 通知內容：**
```
⚠️ 警報通知

姓名：王大明
類型：長時間未活動
最後出現：2026/1/14 下午5:30:00

經過邊界點「社區後門」

請確認長者是否安全。
```

### 4. 硬體模擬器整合

硬體模擬器已更新為符合實際使用情境：

**操作流程：**
1. 選擇社區
2. 選擇長輩（會顯示其 MAC Address）
3. **選擇接收點**（下拉選單會顯示該社區的所有接收點）
   - 顯示格式：「大安社001 - 社區大門 🚨 邊界點」
   - 如果是邊界點會顯示警示符號
4. 設定訊號類型：
   - 📡 **一般訊號**：記錄行蹤
   - 🚨 **緊急求救**：觸發緊急警報
   - ❤️ 健康數據：記錄健康資料
   - 📋 其他訊號
5. 設定 RSSI 訊號強度
6. 設定電池電量
7. 點擊「發送訊號」

**系統處理邏輯：**
- 如果是一般訊號 + 邊界點 → 記錄行蹤 + 發送邊界點警報
- 如果是一般訊號 + 一般接收點 → 僅記錄行蹤
- 如果是緊急求救 → 記錄行蹤 + 發送緊急警報（附帶位置資訊）
- 如果電池不足 → 發送低電量警報

## 資料庫結構

### gateways Collection

```typescript
{
  id: string;                    // Firestore 自動生成
  tenantId: string;              // 所屬社區 ID
  gatewayNumber: string;         // 接收點編號（自動生成：大安社001）
  serialNumber: string;          // 接收裝置序號（SIM-001）
  location: string;              // 地點名稱（社區大門）
  address?: string;              // 詳細地址
  isBoundary: boolean;           // 是否為邊界點
  status: 'active' | 'inactive' | 'maintenance';
  lastSeen?: string;             // 最後上線時間
  notes?: string;                // 備註
  createdAt: string;
  updatedAt: string;
}
```

**範例資料：**
```json
{
  "id": "gateway123",
  "tenantId": "tenant456",
  "gatewayNumber": "大安社001",
  "serialNumber": "SIM-001",
  "location": "社區大門",
  "address": "台北市大安區信義路...",
  "isBoundary": true,
  "status": "active",
  "lastSeen": "2026-01-14T10:00:00.000Z",
  "notes": "主要出入口",
  "createdAt": "2026-01-14T08:00:00.000Z",
  "updatedAt": "2026-01-14T10:00:00.000Z"
}
```

### locationLogs Collection（新增）

```typescript
{
  id: string;                    // Firestore 自動生成
  tenantId: string;              // 所屬社區 ID
  elderId: string;               // 長輩 ID
  elderName: string;             // 長輩姓名（冗餘儲存）
  macAddress: string;            // 長輩的 MAC Address
  gatewayId: string;             // 接收點 ID
  gatewayNumber: string;         // 接收點編號（冗餘儲存）
  location: string;              // 地點名稱（冗餘儲存）
  isBoundary: boolean;           // 是否為邊界點（冗餘儲存）
  rssi: number;                  // 訊號強度
  timestamp: string;             // 經過時間
  createdAt: string;
}
```

**範例資料：**
```json
{
  "id": "locationLog789",
  "tenantId": "tenant456",
  "elderId": "elder123",
  "elderName": "王大明",
  "macAddress": "AA:BB:CC:DD:EE:FF",
  "gatewayId": "gateway123",
  "gatewayNumber": "大安社001",
  "location": "社區大門",
  "isBoundary": true,
  "rssi": -70,
  "timestamp": "2026-01-14T10:30:00.000Z",
  "createdAt": "2026-01-14T10:30:01.000Z"
}
```

## 工作流程

### 情境 1：長輩經過一般接收點

```
1. 長輩佩戴 Beacon 裝置（AA:BB:CC:DD:EE:FF）
   ↓
2. 經過接收點「活動中心」（一般接收點）
   ↓
3. 接收點偵測到訊號，發送到 Cloud Function
   ↓
4. Cloud Function 處理：
   - 查詢長輩資訊
   - 查詢接收點資訊
   - 記錄到 logs collection（訊號記錄）
   - 記錄到 locationLogs collection（行蹤記錄）
   - 更新長輩的 lastSeen 狀態
   ↓
5. 完成（不發送通知）
```

### 情境 2：長輩經過邊界點

```
1. 長輩佩戴 Beacon 裝置（AA:BB:CC:DD:EE:FF）
   ↓
2. 經過接收點「社區後門」（邊界點 🚨）
   ↓
3. 接收點偵測到訊號，發送到 Cloud Function
   ↓
4. Cloud Function 處理：
   - 查詢長輩資訊
   - 查詢接收點資訊（發現是邊界點）
   - 記錄到 logs collection
   - 記錄到 locationLogs collection
   - 創建警報到 alerts collection
   - 發送 LINE 通知給社區管理員 📱
   - 更新長輩的 lastSeen 狀態
   ↓
5. 管理員收到 LINE 通知
   - 通知內容：「王大明 經過邊界點『社區後門』」
   - 可點擊查看詳細資訊
```

### 情境 3：緊急求救

```
1. 長輩按下 Beacon 緊急按鈕
   ↓
2. 最近的接收點偵測到緊急訊號
   ↓
3. Cloud Function 處理：
   - 記錄行蹤（包含位置資訊）
   - 創建緊急警報
   - 發送 LINE 通知：「王大明 觸發緊急求救按鈕！位置：活動中心」
   ↓
4. 所有管理員立即收到通知
```

## 檔案變更清單

### 新增檔案
1. `src/admin/pages/GatewayManagement.tsx` - 接收點管理頁面

### 修改檔案
1. `src/types/index.ts` - 新增 Gateway 和 LocationLog 類型定義
2. `src/admin/components/HardwareSimulator.tsx` - 整合接收點選擇功能
3. `src/admin/pages/AdminDashboard.tsx` - 新增接收點管理按鈕
4. `src/App.tsx` - 新增接收點管理路由
5. `functions/src/receiveSignal.ts` - 處理接收點邏輯和邊界點警報
6. `firestore.indexes.json` - 新增索引

## 測試步驟

### 步驟 1: 新增接收點

1. 訪問 `http://localhost:5176/admin/gateways`
2. 點擊「新增接收點」
3. 填寫資訊：
   - 所屬社區：大愛社區
   - 接收裝置序號：SIM-001
   - 地點名稱：社區大門
   - 詳細地址：（選填）
   - ✅ 設為邊界點
4. 點擊「建立」
5. 應該看到接收點列表中出現「大愛社001 - 社區大門」（邊界點）

### 步驟 2: 新增一般接收點

重複步驟 1，但不勾選「設為邊界點」：
- 接收裝置序號：SIM-002
- 地點名稱：活動中心
- 不勾選邊界點

### 步驟 3: 測試一般訊號（不觸發警報）

1. 訪問 `http://localhost:5176/admin`
2. 在硬體模擬器中：
   - 社區：大愛社區
   - 長輩：王宗愷 (90歲)
   - 接收點：**大愛社002 - 活動中心**（一般接收點）
   - 訊號類型：**📡 一般訊號**
3. 點擊「發送訊號」
4. 檢查結果：
   - ✅ 訊號已成功發送
   - ❌ 不會觸發警報
   - ❌ 不會發送 LINE 通知

### 步驟 4: 測試邊界點警報

1. 在硬體模擬器中：
   - 社區：大愛社區
   - 長輩：王宗愷 (90歲)
   - 接收點：**大愛社001 - 社區大門 🚨 邊界點**
   - 訊號類型：**📡 一般訊號**
2. 點擊「發送訊號」
3. 檢查結果：
   - ✅ 訊號已成功發送
   - ✅ **已觸發警報並發送 LINE 通知**
   - 📱 LINE 應該收到通知：「王宗愷 經過邊界點『社區大門』」

### 步驟 5: 測試緊急求救（帶位置資訊）

1. 在硬體模擬器中：
   - 社區：大愛社區
   - 長輩：王宗愷 (90歲)
   - 接收點：大愛社002 - 活動中心
   - 訊號類型：**🚨 緊急求救**
2. 點擊「發送訊號」
3. 檢查結果：
   - ✅ 訊號已成功發送
   - ✅ 已觸發警報並發送 LINE 通知
   - 📱 LINE 收到：「王宗愷 觸發緊急求救按鈕！位置：活動中心」

### 步驟 6: 檢查 Firestore 資料

1. 進入 Firebase Console > Firestore
2. 檢查 `gateways` collection - 應該有接收點記錄
3. 檢查 `locationLogs` collection - 應該有行蹤記錄
4. 檢查 `alerts` collection - 應該有警報記錄（邊界點和緊急求救）

## 使用情境範例

### 情境 A: 監控社區出入

**設定：**
- 社區大門：設為邊界點
- 社區後門：設為邊界點
- 活動中心：一般接收點
- 餐廳：一般接收點

**效果：**
- 長輩進出社區時會收到通知（防止走失）
- 在社區內活動不會收到通知（避免干擾）
- 可以追蹤長輩的活動軌跡

### 情境 B: 追蹤長輩作息

**透過 locationLogs 分析：**
- 每天幾點去活動中心
- 每天幾點去餐廳用餐
- 活動範圍是否正常
- 是否有異常的移動模式

### 情境 C: 緊急狀況處理

**當長輩按下緊急按鈕：**
1. 系統立即記錄位置（最近的接收點）
2. 發送 LINE 通知給所有管理員
3. 管理員可立即前往該位置協助

## 注意事項

1. **邊界點設定**
   - 建議只將重要出入口設為邊界點
   - 過多邊界點會產生過多通知

2. **接收點命名**
   - 使用清楚易懂的地點名稱
   - 例如：「1樓大門」、「B1停車場」

3. **接收裝置序號**
   - 必須與實際硬體設備的序號一致
   - 格式建議：SIM-001、SIM-002...

4. **行蹤記錄保存**
   - locationLogs 會持續累積
   - 建議定期清理舊資料或設定自動刪除規則

## 未來擴展建議

- [ ] 長輩活動軌跡視覺化
- [ ] 行蹤異常偵測（AI分析）
- [ ] 接收點熱力圖
- [ ] 接收點訊號品質監控
- [ ] 批次匯入接收點
- [ ] 接收點群組管理
- [ ] 可自訂邊界點警報訊息

## 總結

接收點管理功能提供了完整的長輩行蹤追蹤和邊界警報系統，透過設定邊界點，可以在長輩進出社區時立即收到通知，大幅提升社區安全管理效率。
