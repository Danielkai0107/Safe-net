# 裝置電量監控功能說明

## 功能概述

系統現在可以完整監控訊號裝置（Beacon）的電量狀態，並在電量不足時自動發送警報。

## 核心功能

### 1. 電量資訊收集

**資料來源：**
MWC02 定位卡片透過 MG6 閘道器上報電量資訊

**數據格式：**
```json
{
  "macAddress": "AA:BB:CC:DD:EE:FF",
  "rssi": -70,
  "gatewayId": "MG6-001",
  "metadata": {
    "batteryLevel": 85  // 電量百分比 (0-100)
  }
}
```

### 2. 自動更新裝置電量

**處理流程：**
```
1. MG6 閘道器偵測到 Beacon 訊號
   ↓
2. 包含電量資訊發送到 Cloud Function
   ↓
3. Cloud Function 處理：
   - 更新長輩的 lastSeen 狀態
   - 更新裝置的電量資訊（lastBatteryLevel）
   - 記錄電量更新時間（lastBatteryUpdate）
   ↓
4. 如果電量不足，觸發警報
```

**自動更新的欄位：**
- `lastBatteryLevel`: 最新電量百分比
- `lastBatteryUpdate`: 最後電量更新時間
- `updatedAt`: 裝置資料更新時間

### 3. 裝置管理頁面顯示電量

**顯示內容：**
- 📊 電量百分比
- 🔋 電量圖示（根據電量等級變化）
- ⏰ 最後更新時間

**電量等級顯示：**

| 電量範圍 | 圖示 | 顏色 | 狀態 |
|---------|------|------|------|
| 80-100% | 🔋 BatteryFull | 綠色 | 良好 |
| 50-79%  | 🔋 Battery80 | 綠色 | 正常 |
| 20-49%  | 🔋 Battery50 | 橙色 | 注意 |
| 5-19%   | 🔋 Battery20 | 橙色 | 偏低 |
| 0-4%    | ⚠️ BatteryAlert | 紅色 | 危險 |

**範例顯示：**
```
🔋 85%
   01/14 10:30
```

### 4. 低電量警報

**警報觸發條件：**

#### 嚴重低電量（< 5%）
- **嚴重等級**：High
- **警報類型**：low_battery
- **訊息**：「王大明 的裝置電量不足 5%，即將耗盡！」
- **LINE 通知**：✅ 立即發送

#### 一般低電量（< 20%）
- **嚴重等級**：Medium
- **警報類型**：low_battery
- **訊息**：「王大明 的裝置電量不足 20%」
- **LINE 通知**：✅ 立即發送

**注意：**
- 緊急求救時不會觸發低電量警報（避免重複通知）
- 每次電量低於閾值都會發送通知

### 5. 長輩詳細頁面顯示電量

在長輩詳細頁面的訊號記錄中，會顯示每次訊號的電量：

```
📡 一般訊號
2026/1/14 10:30:00

RSSI: -70 dBm
Gateway: MG6-001
電量: 85%
```

## 資料庫結構

### devices Collection（新增欄位）

```typescript
{
  id: string;
  tenantId: string;
  macAddress: string;
  deviceNumber: string;
  status: string;
  assignedElderId?: string;
  assignedElderName?: string;
  lastBatteryLevel?: number;      // 🆕 最新電量 (0-100)
  lastBatteryUpdate?: string;     // 🆕 最後電量更新時間
  notes?: string;
  createdAt: string;
  updatedAt: string;
}
```

**範例資料：**
```json
{
  "id": "device123",
  "tenantId": "tenant456",
  "macAddress": "AA:BB:CC:DD:EE:FF",
  "deviceNumber": "大安社001",
  "status": "assigned",
  "assignedElderId": "elder789",
  "assignedElderName": "王大明",
  "lastBatteryLevel": 85,
  "lastBatteryUpdate": "2026-01-14T10:30:00.000Z",
  "createdAt": "2026-01-14T08:00:00.000Z",
  "updatedAt": "2026-01-14T10:30:00.000Z"
}
```

### logs Collection（已有欄位）

訊號記錄中的 metadata 包含電量資訊：

```typescript
{
  id: string;
  tenantId: string;
  elderId: string;
  macAddress: string;
  rssi: number;
  gatewayId: string;
  signalType: string;
  timestamp: string;
  metadata: {
    batteryLevel?: number;  // 電量資訊
    temperature?: number;
    humidity?: number;
  };
  createdAt: string;
}
```

## 使用情境

### 情境 1：正常電量監控

```
1. 長輩佩戴 MWC02 卡片（電量 85%）
   ↓
2. 經過 MG6 接收點
   ↓
3. MG6 上報訊號 + 電量資訊
   ↓
4. 系統更新裝置電量為 85%
   ↓
5. 裝置管理頁面顯示：🔋 85%（綠色）
```

### 情境 2：低電量警報

```
1. 長輩佩戴的卡片電量降至 18%
   ↓
2. 經過 MG6 接收點
   ↓
3. MG6 上報訊號（電量 18%）
   ↓
4. Cloud Function 處理：
   - 更新裝置電量為 18%
   - 偵測到電量 < 20%
   - 創建低電量警報
   - 發送 LINE 通知
   ↓
5. 管理員收到通知：
   「⚠️ 警報通知
   
   姓名：王大明
   類型：裝置電量不足
   時間：2026/1/14 下午3:00
   
   王大明 的裝置電量不足 20%
   
   請提醒長者充電。」
   ↓
6. 裝置管理頁面顯示：🔋 18%（橙色）
```

### 情境 3：危險低電量

```
1. 卡片電量降至 3%
   ↓
2. 系統偵測到電量 < 5%
   ↓
3. 發送高優先級警報
   ↓
4. LINE 通知：「王大明 的裝置電量不足 5%，即將耗盡！」
   ↓
5. 裝置管理頁面顯示：⚠️ 3%（紅色）
```

## 測試步驟

### 步驟 1: 使用硬體模擬器測試

1. 訪問 `http://localhost:5176/admin`
2. 在硬體模擬器中：
   - 選擇社區、長輩、接收點
   - 訊號類型：一般訊號
   - **電池電量：設為 85**
3. 點擊「發送訊號」
4. 檢查結果：
   - 訪問 `/admin/devices`
   - 找到該長輩的裝置
   - 應該顯示：🔋 85%

### 步驟 2: 測試低電量警報

1. 在硬體模擬器中：
   - **電池電量：設為 18**
2. 點擊「發送訊號」
3. 檢查結果：
   - ✅ 訊號已成功發送
   - ✅ 已觸發警報並發送 LINE 通知
   - 📱 LINE 收到低電量通知
   - 裝置管理顯示：🔋 18%（橙色）

### 步驟 3: 測試危險低電量

1. 在硬體模擬器中：
   - **電池電量：設為 3**
2. 點擊「發送訊號」
3. 檢查結果：
   - 📱 LINE 收到「即將耗盡」通知
   - 裝置管理顯示：⚠️ 3%（紅色）

### 步驟 4: 檢查 Firestore

1. Firebase Console > Firestore
2. 查看 `devices` collection
3. 確認欄位：
   - `lastBatteryLevel`: 3
   - `lastBatteryUpdate`: (最新時間戳)
4. 查看 `alerts` collection
5. 確認有低電量警報記錄

## 實際硬體整合

### MWC02 電量上報

MWC02 定位卡片通常會在每次廣播時包含電量資訊：

**標準 BLE 廣播格式：**
```
Manufacturer Data:
- Battery Level: 0x12 (Service UUID 0x180F)
- Value: 85 (0-100)
```

**MG6 需要解析並上報：**
```json
{
  "macAddress": "AA:BB:CC:DD:EE:FF",
  "rssi": -70,
  "gatewayId": "MG6-001",
  "metadata": {
    "batteryLevel": 85  // 從 BLE 廣播中解析
  }
}
```

### 如果 MG6 不支援電量上報

如果您的 MG6 閘道器不會自動解析電量資訊：

**方案 1: 更新 MG6 韌體**
- 聯繫製造商取得支援電量解析的韌體

**方案 2: 手動估算**
- 根據使用時間估算電量
- 定期手動更新

**方案 3: 使用其他感測器**
- 部分 Beacon 支援額外的電量查詢指令

## 電量管理建議

### 1. 定期檢查

**建議頻率：**
- 每週檢查一次裝置管理頁面
- 重點關注橙色和紅色警示的裝置

### 2. 預防性更換

**建議策略：**
- 電量 < 20%：準備更換電池
- 電量 < 10%：立即更換電池
- 不要等到完全耗盡才更換

### 3. 電池壽命

**MWC02 典型電池壽命：**
- CR2032 電池
- 標準模式：3-6 個月
- 省電模式：6-12 個月

**影響因素：**
- 廣播頻率（越頻繁越耗電）
- 發射功率（越強越耗電）
- 環境溫度（低溫會降低電池效能）

### 4. 批次管理

**建議做法：**
1. 記錄每個裝置的啟用日期
2. 預估更換時間
3. 批次採購備用電池
4. 定期巡檢更換

## 進階功能（未來擴展）

- [ ] 電量趨勢圖表
- [ ] 電量預測（預估剩餘天數）
- [ ] 批次電量檢查報表
- [ ] 自動採購提醒
- [ ] 電量異常偵測（突然下降可能是故障）
- [ ] 電池更換記錄
- [ ] 電池成本統計

## 常見問題

### Q1: 裝置管理頁面顯示「-」沒有電量資訊

**原因：**
1. 尚未收到包含電量的訊號
2. MG6 沒有上報電量資訊
3. 裝置尚未配發給長輩

**解決：**
1. 使用硬體模擬器測試發送包含電量的訊號
2. 檢查 MG6 是否支援電量解析
3. 確認裝置已配發並有長輩使用

### Q2: 電量一直不更新

**檢查：**
1. 長輩是否攜帶裝置
2. 是否經過接收點範圍
3. MG6 是否正常運作
4. 查看 Cloud Function 日誌

### Q3: 收到重複的低電量警報

**說明：**
- 這是正常的，每次偵測到低電量都會發送
- 目的是確保管理員注意到

**改善方案（未來）：**
- 添加警報去重邏輯
- 24小時內同一裝置只發送一次

### Q4: 電量顯示不準確

**可能原因：**
1. Beacon 電量報告不準確
2. 電池品質問題
3. 環境因素（溫度）

**建議：**
- 使用品質穩定的電池
- 定期校準或更換

## 總結

### ✅ 已實作功能

1. **自動收集電量**：從訊號中提取電量資訊
2. **即時更新**：每次收到訊號都更新裝置電量
3. **視覺化顯示**：裝置管理頁面顯示電量圖示和百分比
4. **低電量警報**：電量不足時自動發送 LINE 通知
5. **歷史記錄**：訊號記錄中包含電量資訊

### 📊 電量監控流程

```
MWC02 Beacon → MG6 Gateway → Cloud Function → Firestore
                                     ↓
                              低電量檢查
                                     ↓
                              LINE 通知 + 裝置管理顯示
```

### 🎯 使用效益

- ✅ 即時掌握所有裝置電量狀態
- ✅ 預防裝置因電量耗盡而失聯
- ✅ 及時提醒管理員更換電池
- ✅ 提升系統可靠性

系統現在可以完整監控裝置電量，確保長輩安全監護不中斷！
